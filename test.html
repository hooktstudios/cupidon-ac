<!doctype html>
<html>
  <head>
    <title>Cupidon AC tests</title>
    <link rel="stylesheet" href="vendor/qunit.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.js"></script>
    <script type="text/javascript" src="vendor/qunit.js"></script>
    <script type="text/javascript" src="cupidon-ac.js"></script>
  </head>
  <body>
    <script>
      $(document).ready(function() {

        function cupidonize(sel, options) {
          var $el = $(sel);

          // Destroy previously created widget
          if ($(":ui-cupidon").index($el) > 0) {
            $el.cupidon('destroy');
          }

          // Help prevent traversing in markup generated by other instances
          $el.wrap('<div/>');

          $el.cupidon(options);

          return {
            wrapper: function () {
              return $el.parent().nextAll('.ac-token:visible');
            },
            html: function () {
              return this.wrapper().html();
            },
            value: function () {
              return $el.val();
            },
            edit: function () {
              this.wrapper().find('a:first').trigger('click');
            },
            selectFirstMatch: function (str) {
              $el.cupidon('search', str);
              $el.cupidon('widget').find('.ui-menu-item:first a:first').trigger('mouseenter').trigger('click');
            },
            isInputVisible: function () {
              return $el.is(':visible');
            }
          }
        }

        test("Initialization", function() {
          var cup = cupidonize('#input0');
          deepEqual(cup.html(), null, "Don't cupidonize on page load");
        });

        test("Cupidonize on page load when input is already filled", function() {
          var cup = cupidonize('#input1');
          deepEqual(cup.html(), '<span>Test</span><a class="edit" href="#">Edit</a>', "No options");
          deepEqual(cup.value(), '1', "Keep value");

          var cup = cupidonize('#input1-2', {changeText: 'Modify'});
          deepEqual(cup.html(), '<span>Test</span><a class="edit" href="#">Modify</a>', "changeText option");
        });

        test("Don't cupidonize on page load when input is partially filled", function() {
          var cup = cupidonize('#input2');
          deepEqual(cup.isInputVisible(), true, 'Input is visible');
          deepEqual(cup.html(), null, "Blank ac-token and blank value");

          var cup = cupidonize('#input3');
          deepEqual(cup.isInputVisible(), true, 'Input is visible');
          deepEqual(cup.html(), null, "Blank value");

          var cup = cupidonize('#input4');
          deepEqual(cup.isInputVisible(), true, 'Input is visible');
          deepEqual(cup.html(), null, "Blank ac-token");
          deepEqual(cup.value(), '', "Force blank value when ac-token is blank");
        });

        test("Editing a cupidon", function () {
          var cup = cupidonize('#input1-3');
          cup.edit();
          deepEqual(cup.html(), null, "Hide/Remove plugin output");
          deepEqual(cup.value(), '', "Force blank value");
        });

        test("Cupidonize after select", function() {
          var cup = cupidonize('#input1-4', {
            source: [{label: "Anna", value: 5}, {label: "Bob", value: 6}, {label: "Charles", value: 7}]
          });

          cup.selectFirstMatch('Bo');
          deepEqual(cup.isInputVisible(), false, 'Input is hidden');
          deepEqual(cup.html(), '<span>Bob</span><a class="edit" href="#">Edit</a>', 'HTML');
          deepEqual(cup.value(), '6', 'Value');
        });

      });

    </script>


    <h1 id="qunit-header">Cupidon AC tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">

      <input id="input0" type="text" value="">
      <input id="input0-2" type="text" value="">
      <input id="input1" type="text" data-ac-token="Test" value="1">
      <input id="input1-2" type="text" data-ac-token="Test" value="1">
      <input id="input1-3" type="text" data-ac-token="Test" value="1">
      <input id="input1-4" type="text" value="">
      <input id="input2" type="text" data-ac-token="" value="">
      <input id="input3" type="text" data-ac-token="Test" value="">
      <input id="input4" type="text" data-ac-token="" value="1">
    </div>
  </body>
</html>
