<!doctype html>
<html>
  <head>
    <title>Cupidon AC tests</title>
    <link rel="stylesheet" href="vendor/qunit.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.js"></script>
    <script type="text/javascript" src="vendor/qunit.js"></script>
    <script type="text/javascript" src="cupidon-ac.js"></script>
  </head>
  <body>
    <script>
      $(document).ready(function() {

        // Don't forget to destroy the plugin before reinializing it when using jQueryUI plugin architecture.
        function cupidonize(sel, options) {
          var $el = $(sel);

          // Test sutie commodity to prevent traversing in markup generated by other instances
          $el.wrap('<div/>');

          plugin = (new SelectWithAC($el, options)).init();
          return {
            wrapper: function () {
              return $el.nextAll('.ac-display:visible');
            },
            html: function () {
              return this.wrapper().html();
            },
            value: function () {
              return $el.val();
            },
            edit: function () {
              this.wrapper().find('a:first').trigger('click');
            },
            selectFirstMatch: function (str) {
              $el.autocomplete('search', str);
              $el.autocomplete('widget').find('.ui-menu-item:first a:first').trigger('mouseenter').trigger('click');
            },
            isInputVisible: function () {
              return $el.is(':visible');
            }
          }
        }

        test("Initialization", function() {
          var cup = cupidonize('#input0');
          deepEqual(cup.html(), null, "Don't cupidonize on page load");
        });

        test("Cupidonize on page load when input is already filled", function() {
          var cup = cupidonize('#input1');
          deepEqual(cup.html(), '<p>Test</p><a href=\"#\">Edit</a>', "No options");
          deepEqual(cup.value(), '1', "Keep value");

          var cup = cupidonize('#input1', {changeText: 'Modify'});
          deepEqual(cup.html(), '<p>Test</p><a href=\"#\">Modify</a>', "changeText option");
        });

        test("Don't cupidonize on page load when input is partially filled", function() {
          var cup = cupidonize('#input2');
          deepEqual(cup.isInputVisible(), true, 'Input is visible');
          deepEqual(cup.html(), null, "Blank ac-display and blank value");

          var cup = cupidonize('#input3');
          deepEqual(cup.isInputVisible(), true, 'Input is visible');
          deepEqual(cup.html(), null, "Blank value");

          var cup = cupidonize('#input4');
          deepEqual(cup.isInputVisible(), true, 'Input is visible');
          deepEqual(cup.html(), null, "Blank ac-display");
          deepEqual(cup.value(), '', "Force blank value when ac-display is blank");
        });

        test("Editing a cupidon", function () {
          var cup = cupidonize('#input1');
          cup.edit();
          deepEqual(cup.html(), null, "Hide/Remove plugin output");
          deepEqual(cup.value(), '', "Force blank value");
        });

        test("Cupidonize after select", function() {
          var cup = cupidonize('#input1', {
            source: [{label: "Anna", value: 5}, {label: "Bob", value: 6}, {lable: "Charles", value: 7}]
          });

          cup.selectFirstMatch('Bo');
          deepEqual(cup.isInputVisible(), false, 'Input is hidden');
          deepEqual(cup.html(), '<p>Bob</p><a href=\"#\">Edit</a>', 'HTML');
          deepEqual(cup.value(), '6', 'Value');
        });

      });
    </script>


    <h1 id="qunit-header">Cupidon AC tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture-">

      <input id="input0" type="text" value="">
      <input id="input1" type="text" data-ac-display="Test" value="1">
      <input id="input2" type="text" data-ac-display="" value="">
      <input id="input3" type="text" data-ac-display="Test" value="">
      <input id="input4" type="text" data-ac-display="" value="1">

      <h3>Usage</h3>
      <pre>
        var $input = $('#input');
        (new SelectWithAC($input)).init();
      </pre>
    </div>
  </body>
</html>
